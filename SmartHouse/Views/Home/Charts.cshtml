@model SmartHouse.Models.TemperatureHumidityData

@{
    ViewBag.Title = "Charts";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE HTML>
<html>
<head>
    <script src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
    <script src="https://canvasjs.com/assets/script/jquery.canvasjs.min.js"></script>
    @*<script src="http://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>*@

    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script type="text/javascript" src="http://ticket-compare.com/wp-content/themes/ticket-compare/js/jquery.canvasjs.min.js"></script>
    <script src="~/Scripts/jquery.canvasjs.min.js"></script>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

    <script type="text/javascript">
        window.onload = function () {

            //var today = '0' + (new Date($.now()).getMonth() + 1).toString() + '-' + new Date($.now()).getDate().toString() + '-' + new Date($.now()).getFullYear().toString().toString();
            //$('#TemperatureEvolutionDateTextBox').val(today);

            // Initial Values
            var dataPoints = [];
            var xValue = 0;
            var yValue = 10;
            var newDataCount = 6;
            var dateChanged = false;
            var chartTitle = "Temperature evolution today";

            var chart = new CanvasJS.Chart("chartTemperatureEvolutionToday", {
                theme: "light2",
                zoomEnabled: true,
                zoomType: "xy",
                animationEnabled: true,
                title: {
                    text: chartTitle
                },
                toolTip: {
                    enabled: true,
                    contentFormatter: function (e) {
                        return "Temperature: " + e.entries[0].dataPoint.y + "°C <br>Hour: " + e.entries[0].dataPoint.x.toLocaleTimeString('en-GB') + "<br>Date: " + e.entries[0].dataPoint.x.toLocaleDateString('en-GB');
                    }
                },
                axisX: {
                    title: "Time",
                    intervalType: "minute",
                    interval: 30,
                    valueFormatString: "H:mm"
                },
                axisY: {
                    title: "Temperature (in °C)"
                },
                data: [{
                    type: "spline",
                    dataPoints: dataPoints
                }]
            });
            updateData();

            function addData(data) {
                $.each(data, function (key, value) {
                    if (key == xValue) {
                        dataPoints.push({ x: new Date(new Date(value.x).getFullYear(), new Date(value.x).getMonth(), new Date(value.x).getDate(), new Date(value.x).getHours(), new Date(value.x).getMinutes(), new Date(value.x).getSeconds()), y: value.y });
                        xValue++;
                        yValue = parseInt(value[1]);
                    }
                });

                chart.render();
            }

            function updateData() {

                if (dateChanged) {

                    clearTimeout();

                    var filter = {
                        "DateMinValue": $('#TemperatureEvolutionDateTextBox').val()
                    };

                    $.ajax({
                        url: '@Url.Action("JSONTemperatureChartAnotherDay", "Home")',
                        method: 'GET',
                        data: filter,
                        dataType: 'json',
                        success: function (response) {
                            addData(response);
                        }
                    });
                }
                else {
                    setTimeout(updateData, 1500);

                    $.get("/home/JSONTemperatureChartToday", function (data) {
                        addData(data);
                    });
                }
            }

            $('#TemperatureEvolutionDateTextBox').change(function () {
                // Initial Values
                xValue = 0;
                yValue = 10;
                newDataCount = 6;
                dataPoints = [];
                setTimeout(updateData, 1500);

                var date = $('#TemperatureEvolutionDateTextBox').val();

                if (date == '') {
                    dateChanged = false;
                    chartTitle = "Temperature evolution today";
                }
                else {
                    dateChanged = true;
                    chartTitle = "Temperature evolution on " + new Date(date).toLocaleDateString('en-GB');
                }

                chart = new CanvasJS.Chart("chartTemperatureEvolutionToday", {
                    theme: "light2",
                    zoomEnabled: true,
                    zoomType: "xy",
                    animationEnabled: true,
                    title: {
                        text: chartTitle
                    },
                    toolTip: {
                        enabled: true,
                        contentFormatter: function (e) {
                            return "Temperature: " + e.entries[0].dataPoint.y + "°C <br>Hour: " + e.entries[0].dataPoint.x.toLocaleTimeString('en-GB') + "<br>Date: " + e.entries[0].dataPoint.x.toLocaleDateString('en-GB');
                        }
                    },
                    axisX: {
                        title: "Time",
                        intervalType: "minute",
                        interval: 30,
                        valueFormatString: "H:mm"
                    },
                    axisY: {
                        title: "Temperature (in °C)"
                    },
                    data: [{
                        type: "spline",
                        dataPoints: dataPoints
                    }]
                });
            });

        }
    </script>
</head>
<body>
    <div class="w3-row-padding w3-margin-bottom">
        <label><span>Date </span></label>

        @Html.TextBox("TemperatureEvolutionDate", "", new { id = "TemperatureEvolutionDateTextBox", style = "width:150px; background:#7f9be7", @type = "date" })

        <div id="chartTemperatureEvolutionToday" style="height: 370px; width: 100%;"></div>
    </div>
</body>
</html>


